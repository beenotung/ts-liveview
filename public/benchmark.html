<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>benchmark-web</title>
  </head>
  <body>
    <h1>benchmark</h1>
    <div id="test"></div>
    <div id="out"></div>
    <script src="/socket.io/socket.io.min.js"></script>
    <script src="/js/primus.min.js"></script>
    <script>
      let test = document.querySelector('#test')
      let out = document.querySelector('#out')
      let s
      function init() {
        // s = ''
        out.innerHTML = ''
      }
      function run() {
        // s += 'foo'
        out.innerHTML += 'foo'
      }
      function loop() {
        init()
        let start = Date.now()
        let end = start + 1000
        let n = 0
        for (;;) {
          run()
          n++
          let now = Date.now()
          if (now >= end) {
            end = now
            break
          }
        }
        report(start, end, n)
        requestAnimationFrame(loop)
      }
      // requestAnimationFrame(loop)

      function report(start, end, n) {
        let time = ((end - start) / 1000).toFixed(3)
        let tps = (n / time).toFixed(2)
        let msg = `${n} / ${time} : ${tps}`
        console.log(msg)
        out.textContent = msg
      }

      function loopSocketIO() {
        let socket = io.connect()
        let start = Date.now()
        let end = start + 1000
        let n = 0
        socket.on('echo', data => {
          n++
          socket.emit('echo', data)
          let now = Date.now()
          if (now >= end) {
            report(start, now, n)
            start = now
            end = now + 1000
            n = 0
          }
        })
        socket.emit('echo', Date.now())
      }
      // requestAnimationFrame(loopSocketIO)

      function loopPrimus() {
        let primus = Primus.connect()
        let start = Date.now()
        let end = start + 1000
        let n = 0
        primus.on('data', data => {
          n++
          primus.write(data)
          let now = Date.now()
          if (now >= end) {
            report(start, now, n)
            start = now
            end = now + 1000
            n = 0
          }
        })
        primus.write(Date.now())
      }
      // requestAnimationFrame(loopPrimus)
    </script>
  </body>
</html>
